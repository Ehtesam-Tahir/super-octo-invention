<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fast Product Image Selector</title>
    <style>
        :root {
            --primary-bg: #f8f9fa;
            --secondary-bg: #ffffff;
            --accent-color: #4CAF50;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --highlight-color: #e3f2fd;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            margin: 0;
            color: var(--text-color);
        }
        
        .sticky-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--accent-color);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sticky-counter.pulse {
            transform: scale(1.1);
        }
        
        .product-title {
            font-size: 24px;
            text-align: center;
            margin: 20px 0;
            background-color: var(--highlight-color);
            padding: 10px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        
        .counter {
            background-color: var(--accent-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .progress-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .file-input-container {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }
        
        .file-input-label {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .selected-file {
            margin-top: 10px;
            font-style: italic;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .product-card {
            background-color: var(--secondary-bg);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease;
            cursor: pointer;
            position: relative;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.3s ease forwards;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-card.selected {
            border: 3px solid var(--accent-color);
            background-color: var(--highlight-color);
        }
        
        .product-card.loading {
            background-color: #f8f9fa;
        }
        
        .product-image {
            height: 200px;
            width: 100%;
            object-fit: contain;
            background-color: #f5f5f5;
            transition: opacity 0.3s ease;
        }
        
        .product-image.lazy-loading {
            opacity: 0.3;
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .image-loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 200px;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #666;
            transition: opacity 0.3s ease;
        }
        
        .image-loader.loaded {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .action-bar {
            position: sticky;
            bottom: 0;
            background-color: var(--secondary-bg);
            padding: 15px;
            display: flex;
            justify-content: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .done-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 18px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .done-btn:hover {
            background-color: #388e3c;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .file-contents {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            max-height: 200px;
            overflow: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre;
            display: none;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .secondary-btn {
            background-color: #607D8B;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .debug-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #fff8e1;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .image-placeholder {
            height: 200px;
            width: 100%;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 14px;
        }
        
        #progress-text {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .filtering-info {
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            color: #2e7d32;
        }
        
        .performance-info {
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
            color: #1976d2;
        }
        
        .skeleton-loader {
            height: 200px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div id="sticky-counter" class="sticky-counter">0 selected</div>

    <div class="container">
        <header>
            <h1>Fast Product Image Selector</h1>
            <div class="progress-info">
                <span id="progress-text">Product 0 of 0</span>
                <div class="counter" id="header-counter">0 selected</div>
            </div>
        </header>
        
        <div class="file-input-container">
            <label for="csv-file" class="file-input-label">Select CSV File</label>
            <span id="file-name">No file selected</span>
            <input type="file" id="csv-file" accept=".csv,.txt">
            <div class="selected-file" id="selected-file"></div>
            
            <div class="button-group">
                <button id="show-file-btn" class="secondary-btn">Preview File</button>
                <button id="process-manual-btn" class="secondary-btn">Process File Manually</button>
            </div>
            
            <div id="file-contents" class="file-contents"></div>
            <div id="debug-info" class="debug-info"></div>
        </div>
        
        <div id="error-container"></div>
        <div id="filtering-info" class="filtering-info" style="display: none;"></div>
        <div id="performance-info" class="performance-info" style="display: none;"></div>
        
        <div id="content">
            <div id="loading" class="loading" style="display: none;">Loading products...</div>
            <div id="product-title" class="product-title" style="display: none;"></div>
            <div id="gallery" class="gallery"></div>
        </div>
        
        <div class="action-bar">
            <button id="done-btn" class="done-btn">Select Images & Continue to Next Product</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const csvFileInput = document.getElementById('csv-file');
            const fileNameDisplay = document.getElementById('file-name');
            const selectedFileDisplay = document.getElementById('selected-file');
            const galleryContainer = document.getElementById('gallery');
            const loadingIndicator = document.getElementById('loading');
            const errorContainer = document.getElementById('error-container');
            const doneButton = document.getElementById('done-btn');
            const headerCounter = document.getElementById('header-counter');
            const stickyCounter = document.getElementById('sticky-counter');
            const fileContentsElement = document.getElementById('file-contents');
            const showFileBtn = document.getElementById('show-file-btn');
            const processManualBtn = document.getElementById('process-manual-btn');
            const debugInfoElement = document.getElementById('debug-info');
            const productTitleElement = document.getElementById('product-title');
            const progressText = document.getElementById('progress-text');
            const filteringInfo = document.getElementById('filtering-info');
            const performanceInfo = document.getElementById('performance-info');
            
            // Performance tracking
            let performanceStats = {
                startTime: 0,
                imagesLoaded: 0,
                imagesFailed: 0,
                totalImages: 0
            };
            
            // Image loading optimization
            const imageCache = new Map();
            const loadingQueue = [];
            let currentLoadingBatch = 0;
            const MAX_CONCURRENT_LOADS = 6; // Limit concurrent image loads
            
            // Intersection Observer for lazy loading
            const lazyImageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImageLazily(img);
                        lazyImageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px' // Start loading 50px before the image enters viewport
            });
            
            // Data structures for the application
            let allProductData = [];
            let uniqueProducts = [];
            let currentProductIndex = -1;
            let selectedImages = new Set();
            let fileContents = '';
            let globalSeenImages = new Set();
            
            // Handle file selection
            csvFileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                fileNameDisplay.textContent = file.name;
                selectedFileDisplay.textContent = `Selected: ${file.name}`;
                
                // Reset state
                resetApplicationState();
                
                // Read file contents for preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    fileContents = content;
                    fileContentsElement.textContent = content.substring(0, 1000) + (content.length > 1000 ? '...' : '');
                    
                    // Automatically try to process the file
                    processFile(file);
                };
                reader.readAsText(file);
            });
            
            function resetApplicationState() {
                galleryContainer.innerHTML = '';
                selectedImages.clear();
                globalSeenImages.clear();
                imageCache.clear();
                loadingQueue.length = 0;
                currentLoadingBatch = 0;
                allProductData = [];
                uniqueProducts = [];
                currentProductIndex = -1;
                updateCounter();
                errorContainer.innerHTML = '';
                fileContentsElement.style.display = 'none';
                debugInfoElement.style.display = 'none';
                productTitleElement.style.display = 'none';
                filteringInfo.style.display = 'none';
                performanceInfo.style.display = 'none';
                
                // Reset performance stats
                performanceStats = {
                    startTime: 0,
                    imagesLoaded: 0,
                    imagesFailed: 0,
                    totalImages: 0
                };
            }
            
            // Show file contents preview
            showFileBtn.addEventListener('click', function() {
                if (fileContents) {
                    fileContentsElement.style.display = fileContentsElement.style.display === 'none' ? 'block' : 'none';
                } else {
                    showError("No file loaded. Please select a file first.");
                }
            });
            
            // Process file manually
            processManualBtn.addEventListener('click', function() {
                if (!fileContents) {
                    showError("No file loaded. Please select a file first.");
                    return;
                }
                
                const file = csvFileInput.files[0];
                if (!file) return;
                
                processFileManually(fileContents);
            });
            
            function processFile(file) {
                loadingIndicator.style.display = 'block';
                
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        if (results.errors.length > 0 || !validateData(results.data)) {
                            Papa.parse(file, {
                                header: true,
                                delimiter: '\t',
                                skipEmptyLines: true,
                                dynamicTyping: false,
                                complete: function(results) {
                                    if (results.errors.length > 0 || !validateData(results.data)) {
                                        processFileManually(fileContents);
                                    } else {
                                        loadingIndicator.style.display = 'none';
                                        processCSVData(results.data);
                                    }
                                }
                            });
                        } else {
                            loadingIndicator.style.display = 'none';
                            processCSVData(results.data);
                        }
                    }
                });
            }
            
            function validateData(data) {
                if (!data || data.length === 0) return false;
                
                const firstRow = data[0];
                let hasProductName = false;
                let hasImageUrl = false;
                
                for (let key in firstRow) {
                    if (key && (key.toLowerCase().includes('product') || key.toLowerCase().includes('name'))) {
                        hasProductName = true;
                    }
                    if (key && (key.toLowerCase().includes('image') || key.toLowerCase().includes('url'))) {
                        hasImageUrl = true;
                    }
                }
                
                return hasProductName && hasImageUrl;
            }
            
            function processFileManually(content) {
                debugInfoElement.style.display = 'block';
                debugInfoElement.textContent = "Attempting manual processing...";
                
                const lines = content.split(/\r?\n/).filter(line => line.trim());
                if (lines.length < 2) {
                    showError("Not enough data in the file.");
                    loadingIndicator.style.display = 'none';
                    return;
                }
                
                const firstLine = lines[0];
                let delimiter = ',';
                
                if (firstLine.includes('\t')) {
                    delimiter = '\t';
                    debugInfoElement.textContent += "\nFound tab delimiter";
                } else if (firstLine.includes(',')) {
                    delimiter = ',';
                    debugInfoElement.textContent += "\nFound comma delimiter";
                }
                
                const headers = firstLine.split(delimiter).map(h => h.trim().replace(/"/g, ''));
                debugInfoElement.textContent += "\nHeaders: " + headers.join(', ');
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const fields = lines[i].split(delimiter).map(f => f.trim().replace(/"/g, ''));
                    
                    if (fields.length < headers.length) continue;
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = fields[index] || '';
                    });
                    
                    data.push(row);
                }
                
                debugInfoElement.textContent += "\nExtracted " + data.length + " rows";
                
                if (data.length === 0) {
                    showError("No valid data found in the file.");
                    loadingIndicator.style.display = 'none';
                    return;
                }
                
                processCSVData(data);
                loadingIndicator.style.display = 'none';
            }
            
            function processCSVData(data) {
                if (!data || data.length === 0) {
                    showError("No data found in the file.");
                    return;
                }
                
                performanceStats.startTime = Date.now();
                
                allProductData = data;
                const firstRow = data[0];
                
                let columnNames = Object.keys(firstRow).join(', ');
                debugInfoElement.textContent = "Columns found: " + columnNames;
                debugInfoElement.style.display = 'block';
                
                let productNameKey = null;
                const keys = Object.keys(firstRow);
                
                if (keys.length > 0) {
                    productNameKey = keys[0];
                }
                
                for (let key in firstRow) {
                    if (key && (key.toLowerCase().includes('product') && key.toLowerCase().includes('name'))) {
                        productNameKey = key;
                        break;
                    }
                }
                
                const imageUrlKeys = [];
                for (let key in firstRow) {
                    if (key && key.toLowerCase().includes('image') && key.toLowerCase().includes('url')) {
                        imageUrlKeys.push(key);
                    }
                }
                
                debugInfoElement.textContent += "\nProduct name column: " + productNameKey;
                debugInfoElement.textContent += "\nImage URL columns: " + imageUrlKeys.join(', ');
                
                if (!productNameKey || imageUrlKeys.length === 0) {
                    showError("Could not identify product name or image URL columns.");
                    return;
                }
                
                const productGroups = new Map();
                let totalImages = 0;
                let duplicateImages = 0;
                
                data.forEach(row => {
                    const productName = row[productNameKey];
                    
                    if (!productName || !productName.trim()) return;
                    
                    const cleanProductName = productName.trim();
                    
                    if (!productGroups.has(cleanProductName)) {
                        productGroups.set(cleanProductName, {
                            name: cleanProductName,
                            images: []
                        });
                    }
                    
                    imageUrlKeys.forEach(key => {
                        const url = row[key];
                        if (url && url.trim() && isValidImageUrl(url.trim())) {
                            totalImages++;
                            const cleanUrl = url.trim();
                            
                            if (!globalSeenImages.has(cleanUrl)) {
                                globalSeenImages.add(cleanUrl);
                                productGroups.get(cleanProductName).images.push({
                                    url: cleanUrl,
                                    column: key
                                });
                            } else {
                                duplicateImages++;
                            }
                        }
                    });
                });
                
                uniqueProducts = Array.from(productGroups.values()).filter(product => product.images.length > 0);
                
                performanceStats.totalImages = totalImages - duplicateImages;
                
                filteringInfo.innerHTML = `
                    <strong>Image Processing Summary:</strong><br>
                    • Total images found: ${totalImages}<br>
                    • Duplicate images removed: ${duplicateImages}<br>
                    • Unique images to process: ${totalImages - duplicateImages}<br>
                    • Fast loading optimizations enabled
                `;
                filteringInfo.style.display = 'block';
                
                debugInfoElement.textContent += "\nUnique products found: " + uniqueProducts.length;
                debugInfoElement.textContent += "\nProducts: " + uniqueProducts.map(p => `${p.name} (${p.images.length} images)`).join(', ');
                
                if (uniqueProducts.length === 0) {
                    showError("No valid products with images found in the file.");
                    return;
                }
                
                currentProductIndex = 0;
                displayCurrentProduct();
                updateProgressText();
            }
            
            function isValidImageUrl(url) {
                return typeof url === 'string' && 
                      (url.startsWith('http://') || url.startsWith('https://'));
            }
            
            function displayCurrentProduct() {
                selectedImages.clear();
                updateCounter();
                galleryContainer.innerHTML = '';
                
                if (currentProductIndex < 0 || currentProductIndex >= uniqueProducts.length) {
                    showError("No more products to process.");
                    return;
                }
                
                const currentProduct = uniqueProducts[currentProductIndex];
                
                productTitleElement.textContent = `Product: ${currentProduct.name}`;
                productTitleElement.style.display = 'block';
                
                // Show performance info
                updatePerformanceInfo();
                
                // Create all product cards immediately with lazy loading
                createProductCardsWithLazyLoading(currentProduct);
            }
            
            function createProductCardsWithLazyLoading(product) {
                const fragment = document.createDocumentFragment();
                
                product.images.forEach((image, index) => {
                    const card = createFastProductCard(
                        product.name, 
                        image.url, 
                        image.column, 
                        index + 1
                    );
                    fragment.appendChild(card);
                });
                
                galleryContainer.appendChild(fragment);
                
                // Initialize lazy loading for all images
                const lazyImages = galleryContainer.querySelectorAll('.product-image[data-src]');
                lazyImages.forEach(img => {
                    lazyImageObserver.observe(img);
                });
            }
            
            function createFastProductCard(productName, imageUrl, columnId, imageIndex) {
                const card = document.createElement('div');
                card.className = 'product-card loading';
                card.dataset.url = imageUrl;
                card.dataset.column = columnId;
                
                // Create skeleton loader
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-loader';
                
                const img = document.createElement('img');
                img.className = 'product-image lazy-loading';
                img.alt = productName;
                img.dataset.src = imageUrl; // Use data-src for lazy loading
                
                // Create info div
                const infoDiv = document.createElement('div');
                infoDiv.className = 'product-info';
                infoDiv.innerHTML = `
                    <h3 class="product-name">Image ${imageIndex} (${columnId})</h3>
                    <div style="font-size: 12px; color: #666;" class="image-status">Loading...</div>
                `;
                
                // Assemble card
                card.appendChild(skeleton);
                card.appendChild(img);
                card.appendChild(infoDiv);
                
                // Handle image selection
                card.addEventListener('click', function() {
                    const url = this.dataset.url;
                    
                    if (selectedImages.has(url)) {
                        selectedImages.delete(url);
                        this.classList.remove('selected');
                    } else {
                        selectedImages.add(url);
                        this.classList.add('selected');
                    }
                    
                    updateCounter();
                });
                
                return card;
            }
            
            function loadImageLazily(img) {
                const imageUrl = img.dataset.src;
                const card = img.closest('.product-card');
                const skeleton = card.querySelector('.skeleton-loader');
                const statusDiv = card.querySelector('.image-status');
                
                // Check cache first
                if (imageCache.has(imageUrl)) {
                    const cachedData = imageCache.get(imageUrl);
                    applyImageResult(img, card, skeleton, statusDiv, cachedData);
                    return;
                }
                
                // Create new image for validation
                const validationImg = new Image();
                validationImg.crossOrigin = 'anonymous';
                
                // Set loading timeout
                const loadingTimeout = setTimeout(() => {
                    performanceStats.imagesFailed++;
                    const result = {
                        success: false,
                        dimensions: 'Timeout',
                        error: 'Loading timeout'
                    };
                    imageCache.set(imageUrl, result);
                    applyImageResult(img, card, skeleton, statusDiv, result);
                }, 10000); // 10 second timeout
                
                validationImg.onload = function() {
                    clearTimeout(loadingTimeout);
                    performanceStats.imagesLoaded++;
                    
                    const result = {
                        success: this.naturalWidth >= 200 && this.naturalHeight >= 200,
                        dimensions: `${this.naturalWidth}x${this.naturalHeight}`,
                        width: this.naturalWidth,
                        height: this.naturalHeight
                    };
                    
                    imageCache.set(imageUrl, result);
                    applyImageResult(img, card, skeleton, statusDiv, result);
                    updatePerformanceInfo();
                };
                
                validationImg.onerror = function() {
                    clearTimeout(loadingTimeout);
                    performanceStats.imagesFailed++;
                    
                    const result = {
                        success: false,
                        dimensions: 'Failed to load',
                        error: 'Load error'
                    };
                    
                    imageCache.set(imageUrl, result);
                    applyImageResult(img, card, skeleton, statusDiv, result);
                    updatePerformanceInfo();
                };
                
                validationImg.src = imageUrl;
            }
            
            function applyImageResult(img, card, skeleton, statusDiv, result) {
                card.classList.remove('loading');
                
                if (result.success) {
                    img.src = img.dataset.src;
                    img.classList.remove('lazy-loading');
                    skeleton.style.display = 'none';
                    statusDiv.textContent = `Size: ${result.dimensions}`;
                    statusDiv.style.color = '#4CAF50';
                } else {
                    // Hide or show filtered image
                if (result.success) {
                    img.src = img.dataset.src;
                    img.classList.remove('lazy-loading');
                    skeleton.style.display = 'none';
                    statusDiv.textContent = `Size: ${result.dimensions}`;
                    statusDiv.style.color = '#4CAF50';
                } else {
                    // Show placeholder for failed images
                    img.style.display = 'none';
                    skeleton.innerHTML = `
                        <div style="text-align: center; color: #999;">
                            <div>❌</div>
                            <div style="font-size: 12px;">${result.error || 'Failed to load'}</div>
                        </div>
                    `;
                    statusDiv.textContent = `Error: ${result.dimensions}`;
                    statusDiv.style.color = '#f44336';
                }
            }
            
            function updatePerformanceInfo() {
                const elapsed = Date.now() - performanceStats.startTime;
                const loadedPercent = Math.round((performanceStats.imagesLoaded / performanceStats.totalImages) * 100);
                
                performanceInfo.innerHTML = `
                    <strong>Loading Performance:</strong><br>
                    • Images loaded: ${performanceStats.imagesLoaded}/${performanceStats.totalImages} (${loadedPercent}%)<br>
                    • Failed: ${performanceStats.imagesFailed}<br>
                    • Time elapsed: ${Math.round(elapsed / 1000)}s<br>
                    • Loading speed: ${Math.round(performanceStats.imagesLoaded / (elapsed / 1000))} images/sec
                `;
                performanceInfo.style.display = 'block';
            }
            
            function updateCounter() {
                const count = selectedImages.size;
                const text = `${count} selected`;
                headerCounter.textContent = text;
                stickyCounter.textContent = text;
                
                // Add pulse animation
                stickyCounter.classList.add('pulse');
                setTimeout(() => stickyCounter.classList.remove('pulse'), 300);
            }
            
            function updateProgressText() {
                const total = uniqueProducts.length;
                const current = currentProductIndex + 1;
                progressText.textContent = `Product ${current} of ${total}`;
            }
            
            function showError(message) {
                errorContainer.innerHTML = `<div class="error">${message}</div>`;
            }
            
            // Handle done button
            doneButton.addEventListener('click', function() {
                if (selectedImages.size === 0) {
                    showError("Please select at least one image before continuing.");
                    return;
                }
                
                // Save selected images for current product
                const currentProduct = uniqueProducts[currentProductIndex];
                const selectedUrls = Array.from(selectedImages);
                
                console.log(`Selected ${selectedUrls.length} images for ${currentProduct.name}:`, selectedUrls);
                
                // Move to next product
                currentProductIndex++;
                
                if (currentProductIndex >= uniqueProducts.length) {
                    // All products processed
                    productTitleElement.textContent = "✅ All products processed!";
                    galleryContainer.innerHTML = `
                        <div style="text-align: center; padding: 40px; font-size: 18px; color: #4CAF50;">
                            <h2>🎉 Selection Complete!</h2>
                            <p>All products have been processed. Check the console for selected images.</p>
                        </div>
                    `;
                    doneButton.style.display = 'none';
                    return;
                }
                
                // Display next product
                displayCurrentProduct();
                updateProgressText();
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    doneButton.click();
                }
                
                if (e.key === 'Escape') {
                    selectedImages.clear();
                    updateCounter();
                    document.querySelectorAll('.product-card.selected').forEach(card => {
                        card.classList.remove('selected');
                    });
                }
            });
            
            // Enhanced lazy loading with intersection observer
            const enhancedLazyImageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        loadImageOptimized(img);
                        enhancedLazyImageObserver.unobserve(img);
                    }
                });
            }, {
                rootMargin: '200px', // Load images 200px before they're visible
                threshold: 0.1
            });
            
            function loadImageOptimized(img) {
                const imageUrl = img.dataset.src;
                const card = img.closest('.product-card');
                const skeleton = card.querySelector('.skeleton-loader');
                const statusDiv = card.querySelector('.image-status');
                
                // Check cache first
                if (imageCache.has(imageUrl)) {
                    const cachedData = imageCache.get(imageUrl);
                    applyImageResultOptimized(img, card, skeleton, statusDiv, cachedData);
                    return;
                }
                
                // Show image immediately, validate in background
                img.src = imageUrl;
                img.classList.remove('lazy-loading');
                skeleton.style.opacity = '0.3';
                statusDiv.textContent = 'Loading...';
                statusDiv.style.color = '#666';
                
                // Quick load timeout
                const quickTimeout = setTimeout(() => {
                    skeleton.style.display = 'none';
                    statusDiv.textContent = 'Loaded';
                    statusDiv.style.color = '#4CAF50';
                    performanceStats.imagesLoaded++;
                    updatePerformanceInfo();
                }, 2000);
                
                // Background validation
                const validationImg = new Image();
                validationImg.crossOrigin = 'anonymous';
                
                validationImg.onload = function() {
                    clearTimeout(quickTimeout);
                    performanceStats.imagesLoaded++;
                    
                    const result = {
                        success: this.naturalWidth >= 100 && this.naturalHeight >= 100,
                        dimensions: `${this.naturalWidth}x${this.naturalHeight}`,
                        width: this.naturalWidth,
                        height: this.naturalHeight
                    };
                    
                    imageCache.set(imageUrl, result);
                    applyImageResultOptimized(img, card, skeleton, statusDiv, result);
                    updatePerformanceInfo();
                };
                
                validationImg.onerror = function() {
                    clearTimeout(quickTimeout);
                    performanceStats.imagesFailed++;
                    
                    const result = {
                        success: false,
                        dimensions: 'Failed to load',
                        error: 'Load error'
                    };
                    
                    imageCache.set(imageUrl, result);
                    applyImageResultOptimized(img, card, skeleton, statusDiv, result);
                    updatePerformanceInfo();
                };
                
                validationImg.src = imageUrl;
            }
            
            function applyImageResultOptimized(img, card, skeleton, statusDiv, result) {
                card.classList.remove('loading');
                skeleton.style.display = 'none';
                
                if (result.success) {
                    statusDiv.textContent = `${result.dimensions}`;
                    statusDiv.style.color = '#4CAF50';
                } else {
                    statusDiv.textContent = `Error: ${result.dimensions}`;
                    statusDiv.style.color = '#f44336';
                    // Keep image visible even if validation failed
                }
            }
            
            // Preload next batch of images
            function preloadNextImages() {
                const nextProduct = uniqueProducts[currentProductIndex + 1];
                if (!nextProduct) return;
                
                nextProduct.images.slice(0, 3).forEach(image => {
                    if (!imageCache.has(image.url)) {
                        const preloadImg = new Image();
                        preloadImg.src = image.url;
                    }
                });
            }
            
            // Enhanced display function with faster loading
            function displayCurrentProduct() {
                selectedImages.clear();
                updateCounter();
                galleryContainer.innerHTML = '';
                
                if (currentProductIndex < 0 || currentProductIndex >= uniqueProducts.length) {
                    showError("No more products to process.");
                    return;
                }
                
                const currentProduct = uniqueProducts[currentProductIndex];
                
                productTitleElement.textContent = `Product: ${currentProduct.name}`;
                productTitleElement.style.display = 'block';
                
                updatePerformanceInfo();
                
                // Create cards with enhanced lazy loading
                createProductCardsOptimized(currentProduct);
                
                // Preload next product images
                setTimeout(() => preloadNextImages(), 1000);
            }
            
            function createProductCardsOptimized(product) {
                const fragment = document.createDocumentFragment();
                
                product.images.forEach((image, index) => {
                    const card = createOptimizedProductCard(
                        product.name, 
                        image.url, 
                        image.column, 
                        index + 1
                    );
                    fragment.appendChild(card);
                });
                
                galleryContainer.appendChild(fragment);
                
                // Enhanced lazy loading for all images
                const lazyImages = galleryContainer.querySelectorAll('.product-image[data-src]');
                lazyImages.forEach(img => {
                    enhancedLazyImageObserver.observe(img);
                });
                
                // Load first few images immediately
                lazyImages.forEach((img, index) => {
                    if (index < 4) { // Load first 4 images immediately
                        setTimeout(() => loadImageOptimized(img), index * 100);
                    }
                });
            }
            
            function createOptimizedProductCard(productName, imageUrl, columnId, imageIndex) {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.url = imageUrl;
                card.dataset.column = columnId;
                
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton-loader';
                
                const img = document.createElement('img');
                img.className = 'product-image lazy-loading';
                img.alt = productName;
                img.dataset.src = imageUrl;
                img.loading = 'lazy'; // Native lazy loading
                img.decoding = 'async'; // Async decoding
                
                const infoDiv = document.createElement('div');
                infoDiv.className = 'product-info';
                infoDiv.innerHTML = `
                    <h3 class="product-name">Image ${imageIndex}</h3>
                    <div style="font-size: 12px; color: #666;" class="image-status">Ready</div>
                `;
                
                card.appendChild(skeleton);
                card.appendChild(img);
                card.appendChild(infoDiv);
                
                // Optimized click handler
                card.addEventListener('click', function() {
                    const url = this.dataset.url;
                    
                    if (selectedImages.has(url)) {
                        selectedImages.delete(url);
                        this.classList.remove('selected');
                    } else {
                        selectedImages.add(url);
                        this.classList.add('selected');
                    }
                    
                    updateCounter();
                });
                
                return card;
            }
            
            // Initialize performance tracking
            performanceStats.startTime = Date.now();
        });
    </script>
</body>
</html>
